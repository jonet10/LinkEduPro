generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sex {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum TeacherLevel {
  STANDARD
  VERIFIED
  CERTIFIED
  PREMIUM
}

enum TeacherVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SchoolRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  SCHOOL_ACCOUNTANT
  SCHOOL_TEACHER
}

enum SchoolType {
  PUBLIC
  PRIVATE
  OTHER
}

enum SchoolStudentSex {
  MALE
  FEMALE
  OTHER
}

enum SchoolPaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum LibraryBookStatus {
  PENDING
  APPROVED
  REJECTED
}

model Student {
  id           Int           @id @default(autoincrement())
  firstName    String
  lastName     String
  sex          Sex
  dateOfBirth  DateTime
  school       String
  gradeLevel   String
  email        String?       @unique
  phone        String?
  passwordHash String
  role         UserRole      @default(STUDENT)
  teacherLevel TeacherLevel  @default(STANDARD)
  reputationScore Int        @default(0)
  attempts     QuizAttempt[]
  posts        BlogPost[]
  comments     BlogComment[]
  postLikes    BlogPostLike[] @relation("BlogPostLikeUser")
  approvedPosts BlogPost[] @relation("BlogPostApprover")
  postReports  PostReport[]
  postReportsReviewed PostReport[] @relation("PostReportReviewer")
  reputationEntries ReputationPoint[]
  userBadges   UserBadge[]
  teacherVerifications TeacherVerification[] @relation("TeacherVerificationTeacher")
  teacherVerificationReviews TeacherVerification[] @relation("TeacherVerificationReviewer")
  communityConfigUpdates CommunityConfig[]
  communityLogs CommunityLog[]
  teacherInvitationsCreated TeacherInvitation[] @relation("TeacherInvitationCreator")
  uploadedLibraryBooks LibraryBook[] @relation("LibraryBookUploader")
  reviewedLibraryBooks LibraryBook[] @relation("LibraryBookReviewer")
  notifications UserNotification[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Subject {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  questions   Question[]
  attempts    QuizAttempt[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Question {
  id            Int          @id @default(autoincrement())
  subjectId     Int
  prompt        String
  options       Json
  correctOption Int
  explanation   String?
  isPremium     Boolean      @default(false)
  frequencyScore Int         @default(0)
  sourceTopic   String?
  subject       Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers       QuizAnswer[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model QuizAttempt {
  id             Int          @id @default(autoincrement())
  studentId      Int
  subjectId      Int
  startedAt      DateTime
  finishedAt     DateTime
  durationSec    Int
  score          Int
  totalQuestions Int
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers        QuizAnswer[]
  createdAt      DateTime     @default(now())
}

model QuizAnswer {
  id             Int         @id @default(autoincrement())
  attemptId      Int
  questionId     Int
  selectedOption Int
  isCorrect      Boolean
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
}

model School {
  id            Int                 @id @default(autoincrement())
  name          String
  type          SchoolType
  phone         String
  email         String              @unique
  address       String
  city          String
  country       String
  logo          String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  admins        SchoolAdmin[]
  academicYears SchoolAcademicYear[]
  classes       SchoolClass[]
  students      SchoolStudent[]
  paymentTypes  SchoolPaymentType[]
  payments      SchoolPayment[]
  logs          SchoolLog[]

  @@map("schools")
}

model SchoolAdmin {
  id                   Int           @id @default(autoincrement())
  schoolId             Int?
  firstName            String
  lastName             String
  email                String        @unique
  phone                String?
  passwordHash         String
  role                 SchoolRole
  mustChangePassword   Boolean       @default(true)
  isActive             Boolean       @default(true)
  lastLoginAt          DateTime?
  createdBySuperAdmin  Int?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  school               School?       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  recordedPayments     SchoolPayment[] @relation("PaymentRecordedBy")
  logs                 SchoolLog[]   @relation("SchoolLogActor")

  @@index([schoolId, role])
  @@map("school_admins")
}

model SchoolAcademicYear {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  label       String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     SchoolClass[]
  students    SchoolStudent[]
  payments    SchoolPayment[]

  @@unique([schoolId, label])
  @@index([schoolId, isActive])
  @@map("school_academic_years")
}

model SchoolClass {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  academicYearId Int
  name           String
  level          String?
  capacity       Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  students       SchoolStudent[]
  payments       SchoolPayment[]

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@map("school_classes")
}

model SchoolStudent {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  classId        Int
  academicYearId Int
  studentId      String
  firstName      String
  lastName       String
  sex            SchoolStudentSex
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolClass    SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  payments       SchoolPayment[]

  @@unique([schoolId, studentId])
  @@unique([schoolId, academicYearId, classId, firstName, lastName])
  @@index([schoolId, classId])
  @@map("school_students")
}

model SchoolPaymentType {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  name        String
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payments    SchoolPayment[]

  @@unique([schoolId, name])
  @@map("school_payment_types")
}

model SchoolPayment {
  id              Int               @id @default(autoincrement())
  schoolId        Int
  studentId       Int
  classId         Int
  academicYearId  Int
  paymentTypeId   Int
  amountDue       Decimal           @db.Decimal(10, 2)
  amountPaid      Decimal           @db.Decimal(10, 2)
  status          SchoolPaymentStatus
  receiptNumber   String
  receiptPath     String?
  notes           String?
  recordedById    Int
  paymentDate     DateTime          @default(now())
  deletedAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student         SchoolStudent     @relation(fields: [studentId], references: [id], onDelete: Restrict)
  schoolClass     SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear    SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  paymentType     SchoolPaymentType @relation(fields: [paymentTypeId], references: [id], onDelete: Restrict)
  recordedBy      SchoolAdmin       @relation("PaymentRecordedBy", fields: [recordedById], references: [id], onDelete: Restrict)

  @@unique([schoolId, receiptNumber])
  @@index([schoolId, paymentDate])
  @@index([schoolId, deletedAt])
  @@map("school_payments")
}

model SchoolLog {
  id         Int        @id @default(autoincrement())
  schoolId   Int?
  actorId    Int?
  actorRole  SchoolRole?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime   @default(now())
  school     School?    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  actor      SchoolAdmin? @relation("SchoolLogActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([schoolId, createdAt])
  @@map("school_logs")
}

model TeacherVerification {
  id          Int                       @id @default(autoincrement())
  teacherId   Int
  documentUrl String
  status      TeacherVerificationStatus @default(PENDING)
  reviewedBy  Int?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  teacher     Student                   @relation("TeacherVerificationTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  reviewer    Student?                  @relation("TeacherVerificationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([teacherId, status])
  @@map("teacher_verifications")
}

model BlogPost {
  id          Int       @id @default(autoincrement())
  authorId    Int
  title       String
  content     String
  excerpt     String?
  isGlobal    Boolean   @default(true)
  schoolId    Int?
  isApproved  Boolean   @default(false)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  approvedBy  Int?
  approvedAt  DateTime?
  likeCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      Student   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  approver    Student?  @relation("BlogPostApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  comments    BlogComment[]
  likes       BlogPostLike[]
  categories  PostCategoryOnPost[]
  tags        PostTagOnPost[]
  reports     PostReport[]

  @@index([authorId, createdAt])
  @@index([isApproved, createdAt])
  @@index([schoolId, createdAt])
  @@index([isDeleted, createdAt])
  @@map("posts")
}

model BlogComment {
  id         Int      @id @default(autoincrement())
  postId     Int
  authorId   Int
  content    String
  isHelpful  Boolean  @default(false)
  isDeleted  Boolean  @default(false)
  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  post       BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author     Student  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId, createdAt])
  @@index([isDeleted, createdAt])
  @@map("comments")
}

model BlogPostLike {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  createdAt DateTime @default(now())
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      Student  @relation("BlogPostLikeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId, createdAt])
  @@map("post_likes")
}

model PostCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       PostCategoryOnPost[]

  @@map("post_categories")
}

model PostTag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  posts     PostTagOnPost[]

  @@map("post_tags")
}

model PostCategoryOnPost {
  postId      Int
  categoryId  Int
  assignedAt  DateTime @default(now())
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  category    PostCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@map("post_category_links")
}

model PostTagOnPost {
  postId      Int
  tagId       Int
  assignedAt  DateTime @default(now())
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         PostTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tag_links")
}

model PostReport {
  id          Int      @id @default(autoincrement())
  postId      Int
  reportedBy  Int
  reason      String
  details     String?
  status      String   @default("PENDING")
  reviewedBy  Int?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter    Student  @relation(fields: [reportedBy], references: [id], onDelete: Cascade)
  reviewer    Student? @relation("PostReportReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([postId, createdAt])
  @@index([status, createdAt])
  @@map("post_reports")
}

model ReputationPoint {
  id        Int      @id @default(autoincrement())
  userId    Int
  points    Int
  reason    String
  createdAt DateTime @default(now())
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("reputation_points")
}

model Badge {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  icon        String
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  userId    Int
  badgeId   Int
  awardedAt DateTime @default(now())
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@index([badgeId, awardedAt])
  @@map("user_badges")
}

model CommunityConfig {
  id                  Int      @id
  maxPostsPerDay      Int      @default(3)
  maxPostsPerMonth    Int      @default(10)
  commentRatePerMin   Int      @default(10)
  updatedBy           Int?
  updatedAt           DateTime @updatedAt
  updatedByUser       Student? @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  @@map("community_config")
}

model CommunityLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  actor      Student? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId, createdAt])
  @@index([entityType, createdAt])
  @@map("community_logs")
}

model TeacherInvitation {
  id         Int      @id @default(autoincrement())
  email      String
  token      String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  createdBy  Int
  createdAt  DateTime @default(now())
  usedAt     DateTime?
  creator    Student  @relation("TeacherInvitationCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([email, expiresAt])
  @@index([used, expiresAt])
  @@map("teacher_invitations")
}

model LibraryBook {
  id          Int               @id @default(autoincrement())
  title       String
  subject     String
  level       String
  description String?
  fileUrl     String
  status      LibraryBookStatus @default(PENDING)
  isDeleted   Boolean           @default(false)
  deletedAt   DateTime?
  uploadedBy  Int
  reviewedBy  Int?
  reviewedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  uploader    Student           @relation("LibraryBookUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  reviewer    Student?          @relation("LibraryBookReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([isDeleted, createdAt])
  @@index([uploadedBy, createdAt])
  @@map("library_books")
}

model UserNotification {
  id         Int      @id @default(autoincrement())
  userId     Int
  type       String
  title      String
  message    String
  entityType String?
  entityId   String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("user_notifications")
}
