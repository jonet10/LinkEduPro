generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sex {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  STUDENT
  ADMIN
}

enum SchoolRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  SCHOOL_ACCOUNTANT
  SCHOOL_TEACHER
}

enum SchoolType {
  PUBLIC
  PRIVATE
  OTHER
}

enum SchoolStudentSex {
  MALE
  FEMALE
  OTHER
}

enum SchoolPaymentStatus {
  PENDING
  PARTIAL
  PAID
}

model Student {
  id           Int           @id @default(autoincrement())
  firstName    String
  lastName     String
  sex          Sex
  dateOfBirth  DateTime
  school       String
  gradeLevel   String
  email        String?       @unique
  phone        String?
  passwordHash String
  role         UserRole      @default(STUDENT)
  attempts     QuizAttempt[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Subject {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  questions   Question[]
  attempts    QuizAttempt[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Question {
  id            Int          @id @default(autoincrement())
  subjectId     Int
  prompt        String
  options       Json
  correctOption Int
  explanation   String?
  isPremium     Boolean      @default(false)
  frequencyScore Int         @default(0)
  sourceTopic   String?
  subject       Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers       QuizAnswer[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model QuizAttempt {
  id             Int          @id @default(autoincrement())
  studentId      Int
  subjectId      Int
  startedAt      DateTime
  finishedAt     DateTime
  durationSec    Int
  score          Int
  totalQuestions Int
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers        QuizAnswer[]
  createdAt      DateTime     @default(now())
}

model QuizAnswer {
  id             Int         @id @default(autoincrement())
  attemptId      Int
  questionId     Int
  selectedOption Int
  isCorrect      Boolean
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
}

model School {
  id            Int                 @id @default(autoincrement())
  name          String
  type          SchoolType
  phone         String
  email         String              @unique
  address       String
  city          String
  country       String
  logo          String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  admins        SchoolAdmin[]
  academicYears SchoolAcademicYear[]
  classes       SchoolClass[]
  students      SchoolStudent[]
  paymentTypes  SchoolPaymentType[]
  payments      SchoolPayment[]
  logs          SchoolLog[]

  @@map("schools")
}

model SchoolAdmin {
  id                   Int           @id @default(autoincrement())
  schoolId             Int?
  firstName            String
  lastName             String
  email                String        @unique
  phone                String?
  passwordHash         String
  role                 SchoolRole
  mustChangePassword   Boolean       @default(true)
  isActive             Boolean       @default(true)
  lastLoginAt          DateTime?
  createdBySuperAdmin  Int?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  school               School?       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  recordedPayments     SchoolPayment[] @relation("PaymentRecordedBy")
  logs                 SchoolLog[]   @relation("SchoolLogActor")

  @@index([schoolId, role])
  @@map("school_admins")
}

model SchoolAcademicYear {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  label       String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     SchoolClass[]
  students    SchoolStudent[]
  payments    SchoolPayment[]

  @@unique([schoolId, label])
  @@index([schoolId, isActive])
  @@map("school_academic_years")
}

model SchoolClass {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  academicYearId Int
  name           String
  level          String?
  capacity       Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  students       SchoolStudent[]
  payments       SchoolPayment[]

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@map("school_classes")
}

model SchoolStudent {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  classId        Int
  academicYearId Int
  studentId      String
  firstName      String
  lastName       String
  sex            SchoolStudentSex
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolClass    SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  payments       SchoolPayment[]

  @@unique([schoolId, studentId])
  @@unique([schoolId, academicYearId, classId, firstName, lastName])
  @@index([schoolId, classId])
  @@map("school_students")
}

model SchoolPaymentType {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  name        String
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payments    SchoolPayment[]

  @@unique([schoolId, name])
  @@map("school_payment_types")
}

model SchoolPayment {
  id              Int               @id @default(autoincrement())
  schoolId        Int
  studentId       Int
  classId         Int
  academicYearId  Int
  paymentTypeId   Int
  amountDue       Decimal           @db.Decimal(10, 2)
  amountPaid      Decimal           @db.Decimal(10, 2)
  status          SchoolPaymentStatus
  receiptNumber   String
  receiptPath     String?
  notes           String?
  recordedById    Int
  paymentDate     DateTime          @default(now())
  deletedAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student         SchoolStudent     @relation(fields: [studentId], references: [id], onDelete: Restrict)
  schoolClass     SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear    SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  paymentType     SchoolPaymentType @relation(fields: [paymentTypeId], references: [id], onDelete: Restrict)
  recordedBy      SchoolAdmin       @relation("PaymentRecordedBy", fields: [recordedById], references: [id], onDelete: Restrict)

  @@unique([schoolId, receiptNumber])
  @@index([schoolId, paymentDate])
  @@index([schoolId, deletedAt])
  @@map("school_payments")
}

model SchoolLog {
  id         Int        @id @default(autoincrement())
  schoolId   Int?
  actorId    Int?
  actorRole  SchoolRole?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime   @default(now())
  school     School?    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  actor      SchoolAdmin? @relation("SchoolLogActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([schoolId, createdAt])
  @@map("school_logs")
}
