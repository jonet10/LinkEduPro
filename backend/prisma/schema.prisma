generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sex {
  MALE
  FEMALE
  OTHER
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum TeacherLevel {
  STANDARD
  VERIFIED
  CERTIFIED
  PREMIUM
}

enum TeacherVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SchoolRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  SCHOOL_ACCOUNTANT
  SCHOOL_TEACHER
}

enum SchoolType {
  PUBLIC
  PRIVATE
  OTHER
}

enum SchoolStudentSex {
  MALE
  FEMALE
  OTHER
}

enum SchoolPaymentStatus {
  PENDING
  PARTIAL
  PAID
}

enum LibraryBookStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EducationLevel {
  LEVEL_9E   @map("9e")
  NS1
  NS2
  NS3
  TERMINALE  @map("Terminale")
  UNIVERSITE @map("Universite")
}

enum AcademicLevel {
  LEVEL_9E      @map("9e")
  NSI
  NSII
  NSIII
  NSIV
  UNIVERSITAIRE @map("Universitaire")
}

enum ConversationType {
  PRIVATE @map("private")
  GLOBAL  @map("global")
}

enum ContentType {
  QUIZ     @map("quiz")
  PDF      @map("pdf")
  VIDEO    @map("video")
  REVISION @map("revision")
}

enum ContentStatus {
  DRAFT    @map("draft")
  PENDING  @map("pending")
  APPROVED @map("approved")
  REJECTED @map("rejected")
}

model Student {
  id           Int           @id @default(autoincrement())
  firstName    String
  lastName     String
  sex          Sex
  dateOfBirth  DateTime
  school       String
  gradeLevel   String
  email        String?       @unique
  phone        String?
  address      String?
  passwordHash String
  emailVerified Boolean      @default(false) @map("email_verified")
  verificationToken String?  @map("verification_token")
  tokenExpiry   DateTime?    @map("token_expiry")
  lastWelcomePopupDate DateTime? @map("last_welcome_popup_date")
  usedWelcomeMessageIds Json? @map("used_welcome_message_ids")
  photoUrl     String?       @map("photo_url")
  level        EducationLevel?
  darkMode     Boolean       @default(false) @map("dark_mode")
  role         UserRole      @default(STUDENT)
  teacherLevel TeacherLevel  @default(STANDARD)
  reputationScore Int        @default(0)
  attempts     QuizAttempt[]
  posts        BlogPost[]
  comments     BlogComment[]
  postLikes    BlogPostLike[] @relation("BlogPostLikeUser")
  approvedPosts BlogPost[] @relation("BlogPostApprover")
  postReports  PostReport[]
  postReportsReviewed PostReport[] @relation("PostReportReviewer")
  reputationEntries ReputationPoint[]
  userBadges   UserBadge[]
  teacherVerifications TeacherVerification[] @relation("TeacherVerificationTeacher")
  teacherVerificationReviews TeacherVerification[] @relation("TeacherVerificationReviewer")
  communityConfigUpdates CommunityConfig[]
  communityLogs CommunityLog[]
  teacherInvitationsCreated TeacherInvitation[] @relation("TeacherInvitationCreator")
  uploadedLibraryBooks LibraryBook[] @relation("LibraryBookUploader")
  reviewedLibraryBooks LibraryBook[] @relation("LibraryBookReviewer")
  notifications UserNotification[]
  pomodoroSessions PomodoroSession[]
  submittedContents Content[] @relation("ContentTeacher")
  createdStudyPlans StudyPlan[] @relation("StudyPlanCreator")
  approvalLogs ApprovalLog[] @relation("ContentApprovalAdmin")
  personalStudyPlans PersonalStudyPlan[]
  quizResults QuizResult[]
  searchHistoryEntries SearchHistory[]
  focusSongsCreated FocusSong[]
  focusSongListens FocusSongListen[]
  focusStatistics FocusStatistic[]
  passwordResetCodes PasswordResetCode[]
  sentMessages Message[] @relation("MessageSender")
  conversationParticipants ConversationParticipant[]
  studentProfile StudentProfile?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model WelcomeMessage {
  id        Int      @id @default(autoincrement())
  text      String   @unique
  category  String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("welcome_messages")
}

model StudentProfile {
  id        Int           @id @default(autoincrement())
  userId    Int           @unique @map("user_id")
  level     AcademicLevel
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  user      Student       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([level])
  @@map("student_profiles")
}

model Subject {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String?
  questions   Question[]
  attempts    QuizAttempt[]
  courseTags  CourseTag[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Question {
  id            Int          @id @default(autoincrement())
  subjectId     Int
  prompt        String
  options       Json
  correctOption Int
  explanation   String?
  isPremium     Boolean      @default(false)
  frequencyScore Int         @default(0)
  sourceTopic   String?
  subject       Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers       QuizAnswer[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model QuizAttempt {
  id             Int          @id @default(autoincrement())
  studentId      Int
  subjectId      Int
  startedAt      DateTime
  finishedAt     DateTime
  durationSec    Int
  score          Int
  totalQuestions Int
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject        Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers        QuizAnswer[]
  createdAt      DateTime     @default(now())
}

model QuizAnswer {
  id             Int         @id @default(autoincrement())
  attemptId      Int
  questionId     Int
  selectedOption Int
  isCorrect      Boolean
  attempt        QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
}

model School {
  id            Int                 @id @default(autoincrement())
  name          String
  type          SchoolType
  phone         String
  email         String              @unique
  address       String
  city          String
  country       String
  logo          String?
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  admins        SchoolAdmin[]
  academicYears SchoolAcademicYear[]
  classes       SchoolClass[]
  students      SchoolStudent[]
  paymentTypes  SchoolPaymentType[]
  payments      SchoolPayment[]
  logs          SchoolLog[]

  @@map("schools")
}

model SchoolAdmin {
  id                   Int           @id @default(autoincrement())
  schoolId             Int?
  firstName            String
  lastName             String
  email                String        @unique
  phone                String?
  passwordHash         String
  role                 SchoolRole
  mustChangePassword   Boolean       @default(true)
  isActive             Boolean       @default(true)
  lastLoginAt          DateTime?
  createdBySuperAdmin  Int?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  school               School?       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  recordedPayments     SchoolPayment[] @relation("PaymentRecordedBy")
  logs                 SchoolLog[]   @relation("SchoolLogActor")

  @@index([schoolId, role])
  @@map("school_admins")
}

model SchoolAcademicYear {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  label       String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes     SchoolClass[]
  students    SchoolStudent[]
  payments    SchoolPayment[]

  @@unique([schoolId, label])
  @@index([schoolId, isActive])
  @@map("school_academic_years")
}

model SchoolClass {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  academicYearId Int
  name           String
  level          String?
  capacity       Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  students       SchoolStudent[]
  payments       SchoolPayment[]

  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@map("school_classes")
}

model SchoolStudent {
  id             Int               @id @default(autoincrement())
  schoolId       Int
  classId        Int
  academicYearId Int
  studentId      String
  firstName      String
  lastName       String
  sex            SchoolStudentSex
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolClass    SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear   SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  payments       SchoolPayment[]

  @@unique([schoolId, studentId])
  @@unique([schoolId, academicYearId, classId, firstName, lastName])
  @@index([schoolId, classId])
  @@map("school_students")
}

model SchoolPaymentType {
  id          Int            @id @default(autoincrement())
  schoolId    Int
  name        String
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  payments    SchoolPayment[]

  @@unique([schoolId, name])
  @@map("school_payment_types")
}

model SchoolPayment {
  id              Int               @id @default(autoincrement())
  schoolId        Int
  studentId       Int
  classId         Int
  academicYearId  Int
  paymentTypeId   Int
  amountDue       Decimal           @db.Decimal(10, 2)
  amountPaid      Decimal           @db.Decimal(10, 2)
  status          SchoolPaymentStatus
  receiptNumber   String
  receiptPath     String?
  notes           String?
  recordedById    Int
  paymentDate     DateTime          @default(now())
  deletedAt       DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student         SchoolStudent     @relation(fields: [studentId], references: [id], onDelete: Restrict)
  schoolClass     SchoolClass       @relation(fields: [classId], references: [id], onDelete: Restrict)
  academicYear    SchoolAcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  paymentType     SchoolPaymentType @relation(fields: [paymentTypeId], references: [id], onDelete: Restrict)
  recordedBy      SchoolAdmin       @relation("PaymentRecordedBy", fields: [recordedById], references: [id], onDelete: Restrict)

  @@unique([schoolId, receiptNumber])
  @@index([schoolId, paymentDate])
  @@index([schoolId, deletedAt])
  @@map("school_payments")
}

model SchoolLog {
  id         Int        @id @default(autoincrement())
  schoolId   Int?
  actorId    Int?
  actorRole  SchoolRole?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime   @default(now())
  school     School?    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  actor      SchoolAdmin? @relation("SchoolLogActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([schoolId, createdAt])
  @@map("school_logs")
}

model TeacherVerification {
  id          Int                       @id @default(autoincrement())
  teacherId   Int
  documentUrl String
  status      TeacherVerificationStatus @default(PENDING)
  reviewedBy  Int?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  teacher     Student                   @relation("TeacherVerificationTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  reviewer    Student?                  @relation("TeacherVerificationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([teacherId, status])
  @@map("teacher_verifications")
}

model BlogPost {
  id          Int       @id @default(autoincrement())
  authorId    Int
  title       String
  content     String
  excerpt     String?
  imageUrl    String?   @map("image_url")
  isGlobal    Boolean   @default(true)
  schoolId    Int?
  isApproved  Boolean   @default(false)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  approvedBy  Int?
  approvedAt  DateTime?
  likeCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      Student   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  approver    Student?  @relation("BlogPostApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  comments    BlogComment[]
  likes       BlogPostLike[]
  categories  PostCategoryOnPost[]
  tags        PostTagOnPost[]
  publicationTags PublicationTag[]
  reports     PostReport[]

  @@index([authorId, createdAt])
  @@index([isApproved, createdAt])
  @@index([schoolId, createdAt])
  @@index([isDeleted, createdAt])
  @@map("posts")
}

model BlogComment {
  id         Int      @id @default(autoincrement())
  postId     Int
  authorId   Int
  content    String
  isHelpful  Boolean  @default(false)
  isDeleted  Boolean  @default(false)
  deletedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  post       BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author     Student  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([authorId, createdAt])
  @@index([isDeleted, createdAt])
  @@map("comments")
}

model BlogPostLike {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  createdAt DateTime @default(now())
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      Student  @relation("BlogPostLikeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId, createdAt])
  @@map("post_likes")
}

model PostCategory {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       PostCategoryOnPost[]

  @@map("post_categories")
}

model PostTag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  posts     PostTagOnPost[]

  @@map("post_tags")
}

model PostCategoryOnPost {
  postId      Int
  categoryId  Int
  assignedAt  DateTime @default(now())
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  category    PostCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([postId, categoryId])
  @@map("post_category_links")
}

model PostTagOnPost {
  postId      Int
  tagId       Int
  assignedAt  DateTime @default(now())
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         PostTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@map("post_tag_links")
}

model PostReport {
  id          Int      @id @default(autoincrement())
  postId      Int
  reportedBy  Int
  reason      String
  details     String?
  status      String   @default("PENDING")
  reviewedBy  Int?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter    Student  @relation(fields: [reportedBy], references: [id], onDelete: Cascade)
  reviewer    Student? @relation("PostReportReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([postId, createdAt])
  @@index([status, createdAt])
  @@map("post_reports")
}

model ReputationPoint {
  id        Int      @id @default(autoincrement())
  userId    Int
  points    Int
  reason    String
  createdAt DateTime @default(now())
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("reputation_points")
}

model Badge {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String
  icon        String
  userBadges  UserBadge[]

  @@map("badges")
}

model UserBadge {
  userId    Int
  badgeId   Int
  awardedAt DateTime @default(now())
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@index([badgeId, awardedAt])
  @@map("user_badges")
}

model CommunityConfig {
  id                  Int      @id
  maxPostsPerDay      Int      @default(3)
  maxPostsPerMonth    Int      @default(10)
  commentRatePerMin   Int      @default(10)
  updatedBy           Int?
  updatedAt           DateTime @updatedAt
  updatedByUser       Student? @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  @@map("community_config")
}

model CommunityLog {
  id         Int      @id @default(autoincrement())
  actorId    Int?
  action     String
  entityType String
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  actor      Student? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId, createdAt])
  @@index([entityType, createdAt])
  @@map("community_logs")
}

model TeacherInvitation {
  id         Int      @id @default(autoincrement())
  email      String
  token      String   @unique
  expiresAt  DateTime
  used       Boolean  @default(false)
  createdBy  Int
  createdAt  DateTime @default(now())
  usedAt     DateTime?
  creator    Student  @relation("TeacherInvitationCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([email, expiresAt])
  @@index([used, expiresAt])
  @@map("teacher_invitations")
}

model LibraryBook {
  id          Int               @id @default(autoincrement())
  title       String
  subject     String
  level       String
  description String?
  fileUrl     String
  status      LibraryBookStatus @default(PENDING)
  isDeleted   Boolean           @default(false)
  deletedAt   DateTime?
  uploadedBy  Int
  reviewedBy  Int?
  reviewedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  uploader    Student           @relation("LibraryBookUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  reviewer    Student?          @relation("LibraryBookReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
  @@index([isDeleted, createdAt])
  @@index([uploadedBy, createdAt])
  @@map("library_books")
}

model UserNotification {
  id         Int      @id @default(autoincrement())
  userId     Int
  type       String
  title      String
  message    String
  entityType String?
  entityId   String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("user_notifications")
}

model MusicTrack {
  id        Int            @id @default(autoincrement())
  title     String
  url       String
  level     EducationLevel
  createdAt DateTime       @default(now())

  @@index([level])
  @@map("music_tracks")
}

model PomodoroSession {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  duration  Int
  startTime DateTime? @map("start_time")
  endTime   DateTime? @map("end_time")
  cycleType String?   @map("cycle_type")
  status    String?   @default("COMPLETED")
  createdAt DateTime @default(now()) @map("created_at")
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, startTime, endTime])
  @@map("pomodoro_sessions")
}

model Content {
  id          Int           @id @default(autoincrement())
  title       String
  body        String
  level       EducationLevel
  type        ContentType
  status      ContentStatus @default(PENDING)
  teacherId   Int           @map("teacher_id")
  createdAt   DateTime      @default(now()) @map("created_at")
  teacher     Student       @relation("ContentTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  approvalLogs ApprovalLog[]

  @@index([level, status, createdAt])
  @@index([teacherId, createdAt])
  @@map("contents")
}

model ApprovalLog {
  id        Int      @id @default(autoincrement())
  contentId Int      @map("content_id")
  adminId   Int      @map("admin_id")
  action    String
  timestamp DateTime @default(now())
  content   Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  admin     Student  @relation("ContentApprovalAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([contentId, timestamp])
  @@index([adminId, timestamp])
  @@map("approval_logs")
}

model StudyPlan {
  id          Int            @id @default(autoincrement())
  level       EducationLevel
  subject     String?
  title       String
  description String
  chapterOrder Int?          @map("chapter_order")
  notes       String?
  exercises   String?
  createdById Int?           @map("created_by_id")
  creator     Student?       @relation("StudyPlanCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([level])
  @@index([subject])
  @@index([subject, chapterOrder])
  @@index([createdById])
  @@map("study_plans")
}

model PersonalStudyPlan {
  id                Int       @id @default(autoincrement())
  userId            Int       @map("user_id")
  customPreferences Json?     @map("custom_preferences")
  examDate          DateTime? @map("exam_date")
  user              Student   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("personal_study_plans")
}

model LevelQuiz {
  id        Int             @id @default(autoincrement())
  level     EducationLevel
  title     String
  createdAt DateTime        @default(now()) @map("created_at")
  questions LevelQuestion[]
  results   QuizResult[]

  @@index([level, createdAt])
  @@map("quizzes")
}

model LevelQuestion {
  id           Int      @id @default(autoincrement())
  quizId       Int      @map("quiz_id")
  questionText String   @map("question_text")
  options      Json
  correctAnswer String  @map("correct_answer")
  quiz         LevelQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("questions")
}

model QuizResult {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  quizId      Int      @map("quiz_id")
  score       Int
  completedAt DateTime @default(now()) @map("completed_at")
  user        Student  @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz        LevelQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId, completedAt])
  @@index([quizId, completedAt])
  @@map("quiz_results")
}

model SearchTag {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  publicationTags PublicationTag[]
  courseTags      CourseTag[]

  @@map("tags")
}

model PublicationTag {
  publicationId Int      @map("publication_id")
  tagId         Int      @map("tag_id")
  assignedAt    DateTime @default(now()) @map("assigned_at")
  publication   BlogPost @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  tag           SearchTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([publicationId, tagId])
  @@index([tagId])
  @@map("publication_tags")
}

model CourseTag {
  courseId    Int      @map("course_id")
  tagId       Int      @map("tag_id")
  assignedAt  DateTime @default(now()) @map("assigned_at")
  course      Subject  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag         SearchTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@index([tagId])
  @@map("course_tags")
}

model SearchHistory {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  query     String
  createdAt DateTime @default(now()) @map("created_at")
  user      Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([query])
  @@map("search_history")
}

model PasswordResetCode {
  id        Int      @id @default(autoincrement())
  studentId Int      @map("student_id")
  phone     String?
  email     String?
  codeHash  String   @map("code_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  attempts  Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([phone, createdAt])
  @@index([email, createdAt])
  @@index([studentId, createdAt])
  @@map("password_reset_codes")
}

model Conversation {
  id          Int                       @id @default(autoincrement())
  type        ConversationType
  privateKey  String?                   @unique @map("private_key")
  targetLevel AcademicLevel?            @map("target_level")
  createdAt   DateTime                  @default(now()) @map("created_at")
  messages    Message[]
  participants ConversationParticipant[]

  @@index([type, createdAt])
  @@index([targetLevel])
  @@map("conversations")
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  senderId       Int          @map("sender_id")
  content        String
  createdAt      DateTime     @default(now()) @map("created_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         Student      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@map("messages")
}

model ConversationParticipant {
  id             Int          @id @default(autoincrement())
  conversationId Int          @map("conversation_id")
  userId         Int          @map("user_id")
  lastReadAt     DateTime?    @map("last_read_at")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           Student      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, lastReadAt])
  @@map("conversation_participants")
}

model FocusSong {
  id        Int      @id @default(autoincrement())
  title     String
  url       String
  category  String?
  createdAt DateTime @default(now()) @map("created_at")
  createdBy Int?     @map("created_by")
  listens   FocusSongListen[]
  creator   Student? @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([createdBy, createdAt])
  @@map("focus_songs")
}

model FocusSongListen {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  songId   Int      @map("song_id")
  playedAt DateTime @default(now()) @map("played_at")
  user     Student  @relation(fields: [userId], references: [id], onDelete: Cascade)
  song     FocusSong @relation(fields: [songId], references: [id], onDelete: Cascade)

  @@index([userId, playedAt])
  @@index([songId, playedAt])
  @@map("focus_song_listens")
}

model FocusStatistic {
  id                 Int      @id @default(autoincrement())
  userId             Int      @map("user_id")
  date               DateTime
  totalTime          Int      @default(0) @map("total_time")
  pomodorosCompleted Int      @default(0) @map("pomodoros_completed")
  updatedAt          DateTime @updatedAt @map("updated_at")
  user               Student  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@map("focus_statistics")
}

model Exam {
  id        Int            @id @default(autoincrement())
  subject   String
  year      Int
  level     AcademicLevel
  questions ExamQuestion[]

  @@index([level])
  @@index([subject])
  @@map("exams")
}

model ExamQuestion {
  id           Int    @id @default(autoincrement())
  examId       Int    @map("exam_id")
  questionText String @map("question_text")
  topic        String
  exam         Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([topic])
  @@index([examId])
  @@map("exam_questions")
}
